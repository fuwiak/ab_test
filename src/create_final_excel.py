"""
–°–æ–∑–¥–∞–Ω–∏–µ –∏—Ç–æ–≥–æ–≤–æ–≥–æ Excel —Ñ–∞–π–ª–∞ —Å–æ –≤—Å–µ–º–∏ —Å–≤–æ–¥–Ω—ã–º–∏ —Ç–∞–±–ª–∏—Ü–∞–º–∏
–¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã –ø–æ –∫—É—Ä—Å—É
"""

import pandas as pd
import numpy as np
from datetime import datetime
import openpyxl
from openpyxl.styles import Font, PatternFill, Alignment, Border, Side
from openpyxl.utils.dataframe import dataframe_to_rows

def create_comprehensive_excel_report():
    """–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ Excel –æ—Ç—á—ë—Ç–∞ —Å–æ –≤—Å–µ–º–∏ —Ç–∞–±–ª–∏—Ü–∞–º–∏"""
    
    # –°–æ–∑–¥–∞–Ω–∏–µ Excel writer
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    filename = f"../reports/–§–∏–Ω–∞–ª—å–Ω–∞—è_—Ä–∞–±–æ—Ç–∞_AB_—Ç–µ—Å—Ç_{timestamp}.xlsx"
    
    with pd.ExcelWriter(filename, engine='openpyxl') as writer:
        
        # –õ–∏—Å—Ç 1: –û—Å–Ω–æ–≤–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        create_main_results_sheet(writer)
        
        # –õ–∏—Å—Ç 2: ARPU –ø–æ –≥—Ä—É–ø–ø–∞–º –∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞–º
        create_arpu_analysis_sheet(writer)
        
        # –õ–∏—Å—Ç 3: –î–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã
        create_confidence_intervals_sheet(writer)
        
        # –õ–∏—Å—Ç 4: –°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã
        create_statistical_tests_sheet(writer)
        
        # –õ–∏—Å—Ç 5: –û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        create_data_cleaning_sheet(writer)
        
        # –õ–∏—Å—Ç 6: –ü—Ä–æ–µ–∫—Ü–∏—è –¥–æ—Ö–æ–¥–∞
        create_revenue_projection_sheet(writer)
        
        # –õ–∏—Å—Ç 7: –ë–∏–∑–Ω–µ—Å-—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
        create_business_recommendations_sheet(writer)
    
    # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Excel —Ñ–∞–π–ª–∞
    format_excel_file(filename)
    
    print(f"‚úÖ –°–æ–∑–¥–∞–Ω –∏—Ç–æ–≥–æ–≤—ã–π Excel —Ñ–∞–π–ª: {filename}")
    return filename

def create_main_results_sheet(writer):
    """–õ–∏—Å—Ç 1: –û—Å–Ω–æ–≤–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞"""
    
    # –û—Å–Ω–æ–≤–Ω–∞—è —Å–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞
    main_results = pd.DataFrame({
        '–ú–µ—Ç—Ä–∏–∫–∞': ['ARPU (USD)', 'ARPPU (USD)', '–¢—Ä–∞—Ç—ã –≤–∞–ª—é—Ç—ã (–º–æ–Ω–µ—Ç—ã)'],
        '–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è –≥—Ä—É–ø–ø–∞': [5.8295, 5.8311, 5800.71],
        '–¢–µ—Å—Ç–æ–≤–∞—è –≥—Ä—É–ø–ø–∞': [6.1622, 6.1631, 6229.57],
        '–ê–±—Å–æ–ª—é—Ç–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ': [0.3327, 0.3320, 428.86],
        '–û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ (%)': [5.71, 5.69, 7.39],
        'p-–∑–Ω–∞—á–µ–Ω–∏–µ': ['< 0.000001', '< 0.000001', '< 0.000001'],
        '–°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏ –∑–Ω–∞—á–∏–º–æ': ['‚úÖ –î–ê', '‚úÖ –î–ê', '‚úÖ –î–ê'],
        '–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –∑–Ω–∞—á–∏–º–æ': ['‚úÖ –î–ê', '‚úÖ –î–ê', '‚úÖ –î–ê']
    })
    
    main_results.to_excel(writer, sheet_name='–û—Å–Ω–æ–≤–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã', index=False)
    
    # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—ã–±–æ—Ä–∫–µ
    sample_info = pd.DataFrame({
        '–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å': [
            '–ò—Å—Ö–æ–¥–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤',
            '–£–¥–∞–ª–µ–Ω–æ —á–∏—Ç–µ—Ä–æ–≤',
            '–£–¥–∞–ª–µ–Ω–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö –≤—ã–±—Ä–æ—Å–æ–≤',
            '–§–∏–Ω–∞–ª—å–Ω–∞—è –≤—ã–±–æ—Ä–∫–∞',
            '–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è –≥—Ä—É–ø–ø–∞',
            '–¢–µ—Å—Ç–æ–≤–∞—è –≥—Ä—É–ø–ø–∞',
            '–ü—Ä–æ—Ü–µ–Ω—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö'
        ],
        '–ó–Ω–∞—á–µ–Ω–∏–µ': [
            '8,640,000',
            '353 (0.004%)',
            '346 (0.004%)',
            '8,634,408',
            '4,319,928 (50.0%)',
            '4,314,480 (50.0%)',
            '99.935%'
        ]
    })
    
    # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≤—ã–±–æ—Ä–∫–µ –Ω–∞ —Ç–æ—Ç –∂–µ –ª–∏—Å—Ç
    startrow = len(main_results) + 3
    sample_info.to_excel(writer, sheet_name='–û—Å–Ω–æ–≤–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã', 
                        startrow=startrow, index=False)

def create_arpu_analysis_sheet(writer):
    """–õ–∏—Å—Ç 2: ARPU –ø–æ –≥—Ä—É–ø–ø–∞–º –∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞–º"""
    
    # ARPU –ø–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞–º –∏ –≥—Ä—É–ø–ø–∞–º
    platform_arpu = pd.DataFrame({
        '–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞': ['PC', 'PC', 'PS4', 'PS4', 'Xbox', 'Xbox'],
        '–ì—Ä—É–ø–ø–∞': ['Control', 'Test', 'Control', 'Test', 'Control', 'Test'],
        '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤': [1150285, 1150842, 1150746, 1148250, 1154912, 1152493],
        'ARPU (USD)': [5.6462, 6.2690, 5.7376, 6.0848, 6.1035, 6.1328],
        '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ': [1.8168, 1.9295, 1.8671, 1.8849, 1.9044, 1.9128],
        '–ú–µ–¥–∏–∞–Ω–∞': [5.95, 5.95, 5.95, 5.95, 5.95, 5.95]
    })
    
    platform_arpu.to_excel(writer, sheet_name='ARPU –ø–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞–º', index=False)
    
    # –£–ª—É—á—à–µ–Ω–∏—è –ø–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞–º
    platform_improvements = pd.DataFrame({
        '–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞': ['PC', 'PS4', 'Xbox'],
        'ARPU Control': [5.6462, 5.7376, 6.1035],
        'ARPU Test': [6.2690, 6.0848, 6.1328],
        '–ê–±—Å–æ–ª—é—Ç–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ': [0.6228, 0.3472, 0.0293],
        '–û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ (%)': [11.02, 6.05, 0.48],
        '–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å': ['–í—ã—Å–æ–∫–∞—è', '–°—Ä–µ–¥–Ω—è—è', '–ù–∏–∑–∫–∞—è']
    })
    
    startrow = len(platform_arpu) + 3
    platform_improvements.to_excel(writer, sheet_name='ARPU –ø–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞–º', 
                                  startrow=startrow, index=False)

def create_confidence_intervals_sheet(writer):
    """–õ–∏—Å—Ç 3: 95% –î–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã"""
    
    # –î–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –¥–ª—è ARPU
    arpu_ci = pd.DataFrame({
        '–ú–µ—Ç—Ä–∏–∫–∞': ['ARPU', 'ARPU'],
        '–ì—Ä—É–ø–ø–∞': ['Control', 'Test'],
        '–°—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ': [5.8295, 6.1622],
        '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –æ—à–∏–±–∫–∞': [0.0006, 0.0006],
        '–î–ò –Ω–∏–∂–Ω—è—è –≥—Ä–∞–Ω–∏—Ü–∞': [5.8289, 6.1616],
        '–î–ò –≤–µ—Ä—Ö–Ω—è—è –≥—Ä–∞–Ω–∏—Ü–∞': [5.8301, 6.1628],
        '–ü–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å (¬±)': [0.0006, 0.0006],
        '–†–∞–∑–º–µ—Ä –≤—ã–±–æ—Ä–∫–∏': [4319928, 4314480]
    })
    
    arpu_ci.to_excel(writer, sheet_name='–î–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã', index=False)
    
    # –î–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –¥–ª—è ARPPU
    arppu_ci = pd.DataFrame({
        '–ú–µ—Ç—Ä–∏–∫–∞': ['ARPPU', 'ARPPU'],
        '–ì—Ä—É–ø–ø–∞': ['Control', 'Test'],
        '–°—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ': [5.8311, 6.1631],
        '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –æ—à–∏–±–∫–∞': [0.0006, 0.0006],
        '–î–ò –Ω–∏–∂–Ω—è—è –≥—Ä–∞–Ω–∏—Ü–∞': [5.8305, 6.1625],
        '–î–ò –≤–µ—Ä—Ö–Ω—è—è –≥—Ä–∞–Ω–∏—Ü–∞': [5.8317, 6.1637],
        '–ü–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å (¬±)': [0.0006, 0.0006],
        '–†–∞–∑–º–µ—Ä –≤—ã–±–æ—Ä–∫–∏': [4318720, 4313872]
    })
    
    startrow = len(arpu_ci) + 2
    arppu_ci.to_excel(writer, sheet_name='–î–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã', 
                     startrow=startrow, index=False)
    
    # –î–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –¥–ª—è —Ç—Ä–∞—Ç –≤–∞–ª—é—Ç—ã
    cash_ci = pd.DataFrame({
        '–ú–µ—Ç—Ä–∏–∫–∞': ['–¢—Ä–∞—Ç—ã –≤–∞–ª—é—Ç—ã', '–¢—Ä–∞—Ç—ã –≤–∞–ª—é—Ç—ã'],
        '–ì—Ä—É–ø–ø–∞': ['Control', 'Test'],
        '–°—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ': [5800.71, 6229.57],
        '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –æ—à–∏–±–∫–∞': [1.27, 1.34],
        '–î–ò –Ω–∏–∂–Ω—è—è –≥—Ä–∞–Ω–∏—Ü–∞': [5799.44, 6228.23],
        '–î–ò –≤–µ—Ä—Ö–Ω—è—è –≥—Ä–∞–Ω–∏—Ü–∞': [5801.98, 6230.91],
        '–ü–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å (¬±)': [1.27, 1.34],
        '–†–∞–∑–º–µ—Ä –≤—ã–±–æ—Ä–∫–∏': [4319928, 4314480]
    })
    
    startrow = len(arpu_ci) + len(arppu_ci) + 4
    cash_ci.to_excel(writer, sheet_name='–î–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã', 
                    startrow=startrow, index=False)

def create_statistical_tests_sheet(writer):
    """–õ–∏—Å—Ç 4: –°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã"""
    
    statistical_results = pd.DataFrame({
        '–ú–µ—Ç—Ä–∏–∫–∞': ['ARPU', 'ARPPU', '–¢—Ä–∞—Ç—ã –≤–∞–ª—é—Ç—ã'],
        'Control —Å—Ä–µ–¥–Ω–µ–µ': [5.8295, 5.8311, 5800.71],
        'Test —Å—Ä–µ–¥–Ω–µ–µ': [6.1622, 6.1631, 6229.57],
        '–£–ª—É—á—à–µ–Ω–∏–µ (%)': [5.71, 5.69, 7.39],
        't-—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞': [-258.37, -257.99, -456.73],
        'p-–∑–Ω–∞—á–µ–Ω–∏–µ': ['< 0.000001', '< 0.000001', '< 0.000001'],
        "Cohen's d": [-0.179, -0.179, -0.312],
        '–†–∞–∑–º–µ—Ä —ç—Ñ—Ñ–µ–∫—Ç–∞': ['–ú–∞–ª—ã–π', '–ú–∞–ª—ã–π', '–ú–∞–ª—ã–π'],
        '–°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏ –∑–Ω–∞—á–∏–º–æ': ['‚úÖ –î–ê', '‚úÖ –î–ê', '‚úÖ –î–ê'],
        '–í—ã—Å–æ–∫–æ –∑–Ω–∞—á–∏–º–æ (p<0.001)': ['‚úÖ –î–ê', '‚úÖ –î–ê', '‚úÖ –î–ê']
    })
    
    statistical_results.to_excel(writer, sheet_name='–°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã', index=False)
    
    # –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    interpretation = pd.DataFrame({
        '–ö—Ä–∏—Ç–µ—Ä–∏–π –æ—Ü–µ–Ω–∫–∏': [
            '–°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∞—è –∑–Ω–∞—á–∏–º–æ—Å—Ç—å',
            '–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –∑–Ω–∞—á–∏–º–æ—Å—Ç—å',
            '–ü–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ –¥–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤',
            '–†–∞–∑–º–µ—Ä –≤—ã–±–æ—Ä–∫–∏',
            '–ö–∞—á–µ—Å—Ç–≤–æ –¥–∞–Ω–Ω—ã—Ö',
            '–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤'
        ],
        '–†–µ–∑—É–ª—å—Ç–∞—Ç': [
            '‚úÖ –í—Å–µ –º–µ—Ç—Ä–∏–∫–∏ p < 0.000001',
            '‚úÖ –£–ª—É—á—à–µ–Ω–∏—è 5-7% –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –∑–Ω–∞—á–∏–º—ã',
            '‚ùå –ò–Ω—Ç–µ—Ä–≤–∞–ª—ã –ù–ï –ø–µ—Ä–µ—Å–µ–∫–∞—é—Ç—Å—è',
            '‚úÖ 8.6–ú –∏–≥—Ä–æ–∫–æ–≤ - –æ—Ç–ª–∏—á–Ω–∞—è –º–æ—â–Ω–æ—Å—Ç—å',
            '‚úÖ 99.9% –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏',
            '‚úÖ –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –Ω–∞ –≤—Å–µ—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞—Ö'
        ],
        '–û—Ü–µ–Ω–∫–∞': [
            '–û–¢–õ–ò–ß–ù–û',
            '–û–¢–õ–ò–ß–ù–û', 
            '–û–¢–õ–ò–ß–ù–û',
            '–û–¢–õ–ò–ß–ù–û',
            '–û–¢–õ–ò–ß–ù–û',
            '–û–¢–õ–ò–ß–ù–û'
        ]
    })
    
    startrow = len(statistical_results) + 3
    interpretation.to_excel(writer, sheet_name='–°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã', 
                           startrow=startrow, index=False)

def create_data_cleaning_sheet(writer):
    """–õ–∏—Å—Ç 5: –ü—Ä–æ—Ü–µ—Å—Å –æ—á–∏—Å—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö"""
    
    # –≠—Ç–∞–ø—ã –æ—á–∏—Å—Ç–∫–∏
    cleaning_steps = pd.DataFrame({
        '–≠—Ç–∞–ø': [
            '–ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ',
            '–ü–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —á–∏—Ç–µ—Ä–æ–≤',
            '–ü–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö –≤—ã–±—Ä–æ—Å–æ–≤',
            '–§–∏–Ω–∞–ª—å–Ω–∞—è –≤—ã–±–æ—Ä–∫–∞'
        ],
        '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤': [8640000, 8637176, 8634408, 8634408],
        '–£–¥–∞–ª–µ–Ω–æ –Ω–∞ —ç—Ç–∞–ø–µ': [0, 2824, 2768, 0],
        '–ö—É–º—É–ª—è—Ç–∏–≤–Ω–æ —É–¥–∞–ª–µ–Ω–æ': [0, 2824, 5592, 5592],
        '–ü—Ä–æ—Ü–µ–Ω—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ': [100.0, 99.967, 99.935, 99.935]
    })
    
    cleaning_steps.to_excel(writer, sheet_name='–û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö', index=False)
    
    # –ú–µ—Ç–æ–¥—ã –≤—ã—è–≤–ª–µ–Ω–∏—è –∞–Ω–æ–º–∞–ª–∏–π
    methods = pd.DataFrame({
        '–¢–∏–ø –∞–Ω–æ–º–∞–ª–∏–π': ['–ò–∑–≤–µ—Å—Ç–Ω—ã–µ —á–∏—Ç–µ—Ä—ã', '–°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –≤—ã–±—Ä–æ—Å—ã'],
        '–ú–µ—Ç–æ–¥ –≤—ã—è–≤–ª–µ–Ω–∏—è': ['–§–ª–∞–≥ cheaters = 1', 'IQR –º–µ—Ç–æ–¥ (Q3 + 3√óIQR)'],
        '–ö—Ä–∏—Ç–µ—Ä–∏–π': ['–ü—Ä—è–º–æ–µ —É–∫–∞–∑–∞–Ω–∏–µ –≤ –¥–∞–Ω–Ω—ã—Ö', '–¢—Ä–∞—Ç—ã > 12,650 –º–æ–Ω–µ—Ç'],
        '–í—ã—è–≤–ª–µ–Ω–æ': [353, 346],
        '–ü—Ä–æ—Ü–µ–Ω—Ç –æ—Ç –≤—ã–±–æ—Ä–∫–∏': ['0.004%', '0.004%'],
        '–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è': [
            '–ò—Å–∫–∞–∂–∞—é—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏',
            '–ê–Ω–æ–º–∞–ª—å–Ω—ã–µ —Ç—Ä–∞—Ç—ã (–≤ 2+ —Ä–∞–∑–∞ –≤—ã—à–µ –Ω–æ—Ä–º—ã)'
        ]
    })
    
    startrow = len(cleaning_steps) + 3
    methods.to_excel(writer, sheet_name='–û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö', 
                    startrow=startrow, index=False)

def create_revenue_projection_sheet(writer):
    """–õ–∏—Å—Ç 6: –ü—Ä–æ–µ–∫—Ü–∏—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è –¥–æ—Ö–æ–¥–∞"""
    
    # –ü—Ä–æ–µ–∫—Ü–∏—è –¥–æ—Ö–æ–¥–∞
    revenue_projection = pd.DataFrame({
        '–ü–µ—Ä–∏–æ–¥': ['–î–Ω–µ–≤–Ω–æ–π', '–ù–µ–¥–µ–ª—å–Ω—ã–π', '–ú–µ—Å—è—á–Ω—ã–π', '–ö–≤–∞—Ä—Ç–∞–ª—å–Ω—ã–π', '–ì–æ–¥–æ–≤–æ–π'],
        '–ë–∞–∑–æ–≤—ã–π –¥–æ—Ö–æ–¥ (–º–ª–Ω USD)': [50.3, 352.1, 1509, 4527, 18359],
        '–£–≤–µ–ª–∏—á–µ–Ω–∏–µ –¥–æ—Ö–æ–¥–∞ (–º–ª–Ω USD)': [2.87, 20.09, 86.1, 258.5, 1048.7],
        '–ù–æ–≤—ã–π –¥–æ—Ö–æ–¥ (–º–ª–Ω USD)': [53.17, 372.19, 1595.1, 4785.5, 19407.7],
        '–ü—Ä–∏—Ä–æ—Å—Ç (%)': [5.71, 5.71, 5.71, 5.71, 5.71]
    })
    
    revenue_projection.to_excel(writer, sheet_name='–ü—Ä–æ–µ–∫—Ü–∏—è –¥–æ—Ö–æ–¥–∞', index=False)
    
    # –î–æ–ø—É—â–µ–Ω–∏—è –∏ —Ä–∞—Å—á—ë—Ç—ã
    assumptions = pd.DataFrame({
        '–ü–∞—Ä–∞–º–µ—Ç—Ä': [
            '–ë–∞–∑–æ–≤—ã–π ARPU',
            '–£–ª—É—á—à–µ–Ω–∏–µ ARPU',
            '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤',
            '–î–Ω–µ–≤–Ω–æ–π –±–∞–∑–æ–≤—ã–π –¥–æ—Ö–æ–¥',
            '–î–Ω–µ–≤–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ',
            '–í–∞–ª–∏–¥–Ω–æ—Å—Ç—å –ø—Ä–æ–µ–∫—Ü–∏–∏'
        ],
        '–ó–Ω–∞—á–µ–Ω–∏–µ': [
            '$5.8295',
            '+5.71% (+$0.3327)',
            '8,634,408',
            '$50.3 –º–ª–Ω',
            '+$2.87 –º–ª–Ω',
            '–ù–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏ –∑–Ω–∞—á–∏–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö'
        ],
        '–ò—Å—Ç–æ—á–Ω–∏–∫': [
            '–ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π –≥—Ä—É–ø–ø—ã',
            '–°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–π —Ç–µ—Å—Ç (p<0.000001)',
            '–§–∏–Ω–∞–ª—å–Ω–∞—è –≤—ã–±–æ—Ä–∫–∞ –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏',
            'ARPU √ó –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤',
            '–£–ª—É—á—à–µ–Ω–∏–µ √ó –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤',
            '–î–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª 95%'
        ]
    })
    
    startrow = len(revenue_projection) + 3
    assumptions.to_excel(writer, sheet_name='–ü—Ä–æ–µ–∫—Ü–∏—è –¥–æ—Ö–æ–¥–∞', 
                        startrow=startrow, index=False)

def create_business_recommendations_sheet(writer):
    """–õ–∏—Å—Ç 7: –ë–∏–∑–Ω–µ—Å-—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏"""
    
    # –û—Å–Ω–æ–≤–Ω–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è
    main_recommendation = pd.DataFrame({
        '–ê—Å–ø–µ–∫—Ç': ['–û–°–ù–û–í–ù–ê–Ø –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø'],
        '–†–µ—à–µ–Ω–∏–µ': ['‚úÖ –í–ù–ï–î–†–ò–¢–¨ –ê–ö–¶–ò–Æ –ù–ê –ü–û–°–¢–û–Ø–ù–ù–û–ô –û–°–ù–û–í–ï'],
        '–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ': ['–í—Å–µ –∫–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏ –∏ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –∑–Ω–∞—á–∏–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è'],
        '–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç': ['+5.7% —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –¥–æ—Ö–æ–¥–∞, +7.4% –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏–≥—Ä–æ–∫–æ–≤']
    })
    
    main_recommendation.to_excel(writer, sheet_name='–ë–∏–∑–Ω–µ—Å-—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏', index=False)
    
    # –î–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
    detailed_recommendations = pd.DataFrame({
        '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ': [
            '–í–Ω–µ–¥—Ä–µ–Ω–∏–µ',
            '–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥',
            '–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è',
            '–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ',
            '–†–∏—Å–∫–∏'
        ],
        '–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è': [
            '–ü–æ—ç—Ç–∞–ø–Ω–æ–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ: –Ω–∞—á–∞—Ç—å —Å PC (–Ω–∞–∏–±–æ–ª—å—à–∏–π —ç—Ñ—Ñ–µ–∫—Ç +11%)',
            '–û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å KPI –ø–µ—Ä–≤—ã–µ 3 –º–µ—Å—è—Ü–∞ –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞',
            '–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–∑–º–µ—Ä —Å–∫–∏–¥–∫–∏ –∏ —á–∞—Å—Ç–æ—Ç—É –∞–∫—Ü–∏–π',
            '–ü—Ä–∏–º–µ–Ω–∏—Ç—å –ø–æ–¥—Ö–æ–¥ –∫ –¥—Ä—É–≥–∏–º –∏–≥—Ä–æ–≤—ã–º —ç–ª–µ–º–µ–Ω—Ç–∞–º',
            '–ù–∏–∑–∫–∏–π —Ä–∏—Å–∫ –±–ª–∞–≥–æ–¥–∞—Ä—è –≤—ã—Å–æ–∫–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–æ–π –∑–Ω–∞—á–∏–º–æ—Å—Ç–∏'
        ],
        '–í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä–∞–º–∫–∏': [
            '1-2 –º–µ—Å—è—Ü–∞',
            '3 –º–µ—Å—è—Ü–∞',
            '6 –º–µ—Å—è—Ü–µ–≤',
            '12 –º–µ—Å—è—Ü–µ–≤',
            '–ü–æ—Å—Ç–æ—è–Ω–Ω–æ'
        ],
        '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å': [
            'Product Manager',
            'Data Analytics',
            'Game Design',
            'Product Strategy',
            'Risk Management'
        ]
    })
    
    startrow = len(main_recommendation) + 3
    detailed_recommendations.to_excel(writer, sheet_name='–ë–∏–∑–Ω–µ—Å-—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏', 
                                    startrow=startrow, index=False)
    
    # KPI –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
    kpi_monitoring = pd.DataFrame({
        'KPI': [
            'ARPU',
            'ARPPU', 
            '–ö–æ–Ω–≤–µ—Ä—Å–∏—è –≤ –ø–æ–∫—É–ø–∫–∏',
            'Retention Rate',
            '–¢—Ä–∞—Ç—ã –≤–Ω—É—Ç—Ä–∏–∏–≥—Ä–æ–≤–æ–π –≤–∞–ª—é—Ç—ã',
            'NPS (Net Promoter Score)'
        ],
        '–¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ': [
            '$6.16 (—Ç–µ—Å—Ç –≥—Ä—É–ø–ø–∞)',
            '$6.16 (—Ç–µ—Å—Ç –≥—Ä—É–ø–ø–∞)',
            '–¢—Ä–µ–±—É–µ—Ç –∏–∑–º–µ—Ä–µ–Ω–∏—è',
            '–¢—Ä–µ–±—É–µ—Ç –∏–∑–º–µ—Ä–µ–Ω–∏—è',
            '6,230 –º–æ–Ω–µ—Ç (—Ç–µ—Å—Ç –≥—Ä—É–ø–ø–∞)',
            '–¢—Ä–µ–±—É–µ—Ç –∏–∑–º–µ—Ä–µ–Ω–∏—è'
        ],
        '–¶–µ–ª–µ–≤–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ': [
            '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å +5.7%',
            '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å +5.7%',
            '–ù–µ —Å–Ω–∏–∂–∞—Ç—å',
            '–ù–µ —Å–Ω–∏–∂–∞—Ç—å',
            '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å +7.4%',
            '–£–ª—É—á—à–∏—Ç—å'
        ],
        '–ß–∞—Å—Ç–æ—Ç–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è': [
            '–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ',
            '–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ',
            '–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ',
            '–ï–∂–µ–º–µ—Å—è—á–Ω–æ',
            '–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ',
            '–ï–∂–µ–º–µ—Å—è—á–Ω–æ'
        ]
    })
    
    startrow = len(main_recommendation) + len(detailed_recommendations) + 6
    kpi_monitoring.to_excel(writer, sheet_name='–ë–∏–∑–Ω–µ—Å-—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏', 
                           startrow=startrow, index=False)

def format_excel_file(filename):
    """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Excel —Ñ–∞–π–ª–∞ –¥–ª—è –ª—É—á—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏"""
    
    # –ó–∞–≥—Ä—É–∑–∫–∞ workbook
    wb = openpyxl.load_workbook(filename)
    
    # –°—Ç–∏–ª–∏
    header_font = Font(bold=True, color="FFFFFF")
    header_fill = PatternFill(start_color="366092", end_color="366092", fill_type="solid")
    alignment_center = Alignment(horizontal="center", vertical="center")
    thin_border = Border(
        left=Side(style='thin'),
        right=Side(style='thin'), 
        top=Side(style='thin'),
        bottom=Side(style='thin')
    )
    
    # –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∏–ª–µ–π –∫–æ –≤—Å–µ–º –ª–∏—Å—Ç–∞–º
    for sheet_name in wb.sheetnames:
        ws = wb[sheet_name]
        
        # –ê–≤—Ç–æ—à–∏—Ä–∏–Ω–∞ –∫–æ–ª–æ–Ω–æ–∫
        for column in ws.columns:
            max_length = 0
            column_letter = column[0].column_letter
            
            for cell in column:
                try:
                    if len(str(cell.value)) > max_length:
                        max_length = len(str(cell.value))
                except:
                    pass
            
            adjusted_width = min(max_length + 2, 50)
            ws.column_dimensions[column_letter].width = adjusted_width
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
        for row in ws.iter_rows(min_row=1, max_row=1):
            for cell in row:
                if cell.value:
                    cell.font = header_font
                    cell.fill = header_fill
                    cell.alignment = alignment_center
                    cell.border = thin_border
        
        # –ì—Ä–∞–Ω–∏—Ü—ã –¥–ª—è –≤—Å–µ—Ö —è—á–µ–µ–∫ —Å –¥–∞–Ω–Ω—ã–º–∏
        for row in ws.iter_rows():
            for cell in row:
                if cell.value:
                    cell.border = thin_border
    
    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
    wb.save(filename)

def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è Excel –æ—Ç—á—ë—Ç–∞"""
    
    print("üìä –°–æ–∑–¥–∞–Ω–∏–µ –∏—Ç–æ–≥–æ–≤–æ–≥–æ Excel —Ñ–∞–π–ª–∞ –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã...")
    print("=" * 70)
    
    filename = create_comprehensive_excel_report()
    
    print("\nüìã –°–æ–∑–¥–∞–Ω–Ω—ã–µ –ª–∏—Å—Ç—ã:")
    print("   1. –û—Å–Ω–æ–≤–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã - –≥–ª–∞–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –∏ –≤—ã–±–æ—Ä–∫–∞")
    print("   2. ARPU –ø–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞–º - –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–æ PC/PS4/Xbox")
    print("   3. –î–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã - 95% –î–ò –¥–ª—è –≤—Å–µ—Ö –º–µ—Ç—Ä–∏–∫")
    print("   4. –°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã - t-—Ç–µ—Å—Ç—ã –∏ —Ä–∞–∑–º–µ—Ä—ã —ç—Ñ—Ñ–µ–∫—Ç–∞")
    print("   5. –û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö - –º–µ—Ç–æ–¥—ã –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—á–∏—Å—Ç–∫–∏")
    print("   6. –ü—Ä–æ–µ–∫—Ü–∏—è –¥–æ—Ö–æ–¥–∞ - —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø—Ä–æ–≥–Ω–æ–∑—ã")
    print("   7. –ë–∏–∑–Ω–µ—Å-—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ - –≤—ã–≤–æ–¥—ã –∏ –ø–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π")
    
    print(f"\n‚úÖ Excel —Ñ–∞–π–ª –≥–æ—Ç–æ–≤: {filename}")
    print("üìé –ì–æ—Ç–æ–≤ –∫ –≤–∫–ª—é—á–µ–Ω–∏—é –≤ —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Ä–∞–±–æ—Ç—É –ø–æ –∫—É—Ä—Å—É!")

if __name__ == "__main__":
    main() 